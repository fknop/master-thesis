% !TEX root = ../../thesis.tex

\documentclass[../../thesis.tex]{subfiles}
 
\begin{document}


\section{Mixed Integer Programming Model}
\label{section:mipmodel}

We first start by presenting the mathematical model, we describe the variables
needed to model our problem and the constraints associated to them.

\subsection{Variables}

To represent our problem in MIP, we will need three types of variables, one per resource.



\begin{equation*}
\begin{split}
    w_{ijkl} &=  \left \{
                   \begin{array}{l l}
                      1 \quad & \textrm{if worker $i$ is working at time $j$ for demand $k$ at position $l$} \\
                      0 \quad & \textrm{otherwise} 
                   \end{array}
                   \right . \\
  f_{jkl} &=  \left \{
  \begin{array}{l l}
      1 \quad & \textrm{if no worker is assigned at time $j$ for demand $k$ at position $l$} \\
      0 \quad & \textrm{otherwise} 
  \end{array}
  \right . \\
   m_{ij} &=  \left \{
                   \begin{array}{l l}
                      1 \quad & \textrm{if machine $i$ is used for demand $j$} \\
                      0 \quad & \textrm{otherwise} 
                   \end{array}
                   \right . \\
    z_{ij} &= \left \{
               \begin{array}{l l}
                  1 \quad & \textrm{if zone $i$ is used for demand $j$} \\
                  0 \quad & \textrm{otherwise} 
               \end{array}
               \right . \\
\end{split}
\end{equation*}

This is in fact a binary Integer Programming model as every variables is a $\{0, 1\}$ integer.

As solution can be partial, we need to introduce a way to allow the absence of worker for a 
given position. In MIP, we model this by having the variables $f_{jkl}$, $f$ for \emph{fictitious}. This variable is one, if and only if all the 
corresponding worker variables ($w_{ijkl}, \forall_i$) are equal to zero. The goal will be to minimize 
the number of fictitious variables assigned to one.

\subsection{Constraints}

\subsubsection{All positions must be assigned with one worker}

  All positions must have one worker assigned to it. We achieve this by summing all the worker variables 
  for each position. We also add the fictitious variable associated to this position to allow partial 
  solutions.

  \begin{align}
    \sum_{i \in W} w_{ijkl} + f_{jkl} = 1, && \forall k \in D, j \in d_k^T, l \in d_k^P & \label{wc1}
  \end{align}


\autoref{wc1:visu} shows a visualization of constraints (\ref{wc1}) and (\ref{wc2}) for one time period.
However, to simplify, we suppose that demands only need one worker, thus ignoring positions.

\begin{figure}[]
  \centering
  \begin{tikzpicture}[
    node distance=1mm and 0mm,
    baseline]
    \matrix (M1) [matrix of math nodes,row sep=0.2em, column sep=0.3em]
    {
      w_{11}  &  +  &  w_{21} &  +    & \dots   & +  &   w_{n1}  &= 1    \\
      +       &     &   +     &       &   &   & \\
      w_{12}  &  +  &  w_{22} &  +    & \dots   & +  &   w_{n2}  &= 1    \\
      +       &     &     +   &       &         &    &       +           \\   
      \vdots  &     &  \vdots &      & \ddots   &   &   \vdots    \\ 
      +       &     &     +   &       &         &    &       +           \\ 
      w_{1m}  &  +  &  w_{2m} &  +    & \dots   & +  &   w_{nm}  &= 1    \\ 
      \leq 1  &     &  \leq 1 &       &         &    &    \leq 1        \\
    };
    % \draw   (M1-1-7.north east) -- (M1-7-7.south east);
    % \draw   (M1-7-1.south west) -- (M1-7-7.south east);
    \draw[red,very thick] 
            (M1-1-1.north west) -| (M1-1-8.south east) -| (M1-1-1.north west);
    \draw[blue,very thick] 
      (M1-1-3.north west) -| (M1-8-3.south east) -| (M1-1-3.north west);
    \draw[green,thick] 
      (M1-7-7.north west) -| (M1-7-7.south east) -| (M1-7-7.north west);
    \node (fv) [below right=of M1.south east,align=left,
                font=\sffamily\bfseries] {Different\\workers};
    \draw[blue!60,very thick,shorten >=1mm,-{Stealth[bend]}] 
            (fv.west) to [out=180,in=270] (M1-8-3.south);
    \node (fv2) [above right=of M1.north west,align=left,
     font=\sffamily\bfseries] {Position\\satisfied};
    \draw[red!60,very thick,shorten >=1mm,-{Stealth[bend]}] 
     (fv2.west) to [out=180,in=180] (M1-1-1.west);
     \node (fv3) [right=1cm of M1.east,align=left,
     font=\sffamily\bfseries] {Worker $n$ for\\demand $m$};
     \draw[green!60,thick,shorten >=1mm,-{Stealth[bend]}] 
     (fv3.west) to [out=180,in=0] (M1-7-7.north east);
  \end{tikzpicture}

  \caption{Visualization of (\ref{wc1}) and (\ref{wc2}).}
  \label{wc1:visu}
\end{figure}

\subsubsection{All workers assigned in a time period must be different}

One worker can only work one time per time period. For each worker, we add the sum of all its variables 
over each time period. This sum must be less or equal than one to make sure it works at most once in the period.

\begin{align}
  \sum_{k \in D} \sum_{l \in d_k^P} w_{ijkl} \leq 1, && \forall i \in W, j \in T & \label{wc2} 
\end{align}


\subsubsection{Exclude impossible values}

Some workers (demands) are not available (occurring) at one time period. We need to set the variables to 0 if this is the case.

\begin{align}
  t_j \notin d^T_{k} \implies \forall i, l \ w_{ijkl} = 0,  && \forall j \in T , k \in D &\label{wc3} \\
  t_j \notin w^T_{i} \implies \forall k, l \ w_{ijkl} = 0, && \forall j \in T, i \in W &\label{wc4} \\
  t_j \notin d^T_{k} \implies \forall l \ s_{jkl} = 0,  && \forall j \in T , k \in D &\label{sc1} 
\end{align}

\subsubsection{Incompatibilities between workers and clients}

For each incompatibility $(i, c) \in I_{wc}$, we set every worker variables of worker $i$ if the client of the 
demand is $c$.

\begin{align}
  d^c_{k} = c \implies \forall l \ w_{ijkl} = 0, && \forall {(i, c) \in I_{wc}}, j \in T, k \in D &\label{wc6}
\end{align}

\subsubsection{Incompatibilities between workers}

For each incompatibility, at each demand, two workers cannot have both their variable assigned to one. 
We define that the sum over all the positions of the two incompatible workers must be less than two.

\begin{align}
  \sum_{l \in d^P_k} w_{ajkl} + w_{bjkl} < 2, &&  \forall {(a, b) \in I_{ww}}, j \in T, k \in D &\label{wc5}
\end{align}



\begin{figure}[]
  \centering
  \begin{tikzpicture}[
    node distance=1mm and 0mm,
    baseline]
    \matrix (M1) [matrix of math nodes,row sep=0.5em, column sep=0.3em]
    {
      \ & w_{11}  &  +  &  w_{21} &  +   &  w_{31} &  +   & \dots   & +  &   w_{n1}  \\
      \color{red} + & w_{12}  &  +  &  w_{22} &  +   & w_{32}  &  +   & \dots   & +  &   w_{n2}   \\
      \color{blue} + & w_{13}  &  +  &  w_{23} &  +   & w_{33}  &  +   & \dots   & +  &   w_{n3}   \\
      \ & \vdots  &     &  \vdots &      & \vdots  &      & \vdots   &   &   \vdots \\ 
      \ & w_{1m}  &  +  &  w_{2m} &  +   &  w_{3m} &  +   & \dots   & +  &   w_{nm}    \\
      \\
    };

    \draw[red] 
          (M1-2-2.south west) -| (M1-1-10.north east) -| (M1-2-2.south west);
    \draw[blue] 
      (M1-3-2.south west) -| (M1-2-10.north east) -| (M1-3-2.south west);
    
    \node[color=red] (fv) [right=of M1-1-10.south east,align=left,
    font=\sffamily\bfseries] {${< 2}$};

    \node[color=blue] (fv2) [right=of M1-3-10.north east,align=left,
     font=\sffamily\bfseries] {${< 2}$};

    \draw[purple,thick] 
        (M1-5-10.north west) -| (M1-5-10.south east) -| (M1-5-10.north west);
     \node (fv3) [right=1cm of M1.south east,align=left,
     font=\sffamily\bfseries] {Worker $m$ for\\position $n$};
     \draw[purple!60,thick,shorten >=1mm,-{Stealth[bend]}] 
     (fv3.west) to [out=180,in=0] (M1-5-10.east);
  \end{tikzpicture}

  \caption{Example of (\ref{wc5}) if $(w_1, w_2)$ and $(w_2, w_3)$ are incompatible pairs.}
  \label{wc5:visu}
\end{figure}

\subsubsection{Restrict skilled positions to skilled workers}

These constraints ensure that no worker is working for a position at which he is not qualified to work.
$W_{d^{s_l}_k}$ define the workers that satisfy skill(s) $s_l$ of demand $k$. 

\begin{align}
  w_{ijkl} = 0, && \forall j \in T, k \in D, l \in d^P_k, i \in W \setminus W_{d^{s_l}_k}  \label{wc6}
\end{align}

\subsubsection{Additional skills must be satisfied}

\begin{align}
  \sum_{l \in d_k^P} w_{ijkl} \geq 1, && \forall j \in T, k \in D, s \in d^{S^+}_k, i \in W_{d^{S^+}_k}& \label{wc8}
\end{align}

\subsubsection{Binary constraints}

These constraints simply state that each variable must be a binary $\{ 0, 1 \}$ variable.

\begin{align}
  w_{ijkl} \in \{0, 1\}, && \forall i \in W, j \in T, k \in D, l \in d^P_k &\label{binary1} \\
  s_{jkl} \in \{0, 1\}, && \forall j \in T, k \in D, l \in d^P_k& \label{binary2} \\
  m_{ij} \in \{0, 1\}, && \forall i \in M, j \in D& \label{binary3} \\ 
  z_{ij} \in \{0, 1\}, && \forall i \in Z, j \in D& \label{binary4} 
\end{align}

\subsection{Objective}


\begingroup
\allowdisplaybreaks
\begin{subequations}
  \label{obj}
  \begin{align}
    \textrm{min} \quad & \delta_0 \sum_{k \in D} \sum_{l \in d^P_k} \sum_{i \in W} min(\sum_{j \in T} w_{ijkl}, 1) \label{obj:1} \\ 
      + \ & \delta_1 \sum_{r \in R} \big( max(r_{min} - occ_{r_{w}}, 0) + max(r_{max} - occ_{r_{w}}, 0) \big)  \label{obj:3} \\ 
      + \ &\delta_2 \sum_{j \in T}\sum_{k\in D}\sum_{l \in d^P_k} f_{jkl} \label{obj:2} \\ 
     \textrm{with} \quad & occ_i = \sum_{j \in T} \sum_{k \in D} \sum_{l \in d^P_j} w_{ijkl}, \quad \forall i \in W  \nonumber \\ 
                         & \bm{\delta} = (\delta_0, \delta_1, \delta_2) = (1, 15, 100) \nonumber
  \end{align}
\end{subequations}
\endgroup


The objective function is stated in (\ref{obj}), it is a weighted sum split in multiple parts, it minimizes:

\begin{enumerate}
  \item The number of different workers for every position between periods of that demand (\ref{obj:1}), $min(\sum_{j \in T} w_{ijkl}, 1)$ is one if the worker $i$ is working for that position at that time, 0 otherwise. Hence, the sum of that value for all worker will be equal to the number of worker for that shift.
  \item The number of violations of working requirements (\ref{obj:3}).
  \item The number of \emph{fictitious} worker assigned to demands (\ref{obj:2}).
\end{enumerate}

$occ_i$ represents the occurrences of worker $i$ while the penalties $\bm{\delta}$ are representative of the importance of each sub-objectives.

% \subsection{Complete Model}



% \begingroup
% \allowdisplaybreaks
% \begin{subequations}
%   \label{obj}
%   \begin{align}
%     \textrm{min} \quad & \sum_{k \in D} \sum_{l \in d^P_k} \sum_{i \in W} min(\sum_{j \in T} w_{ijkl}, 1) & \qquad & \quad \label{obj:1} \\ 
%      & + \sum_{j \in T}\sum_{k\in D}\sum_{l \in d^P_k} s_{jkl}  & \qquad &  \quad \label{obj:2} \\ 
%      & + \sum_{r \in R} \big( max(r_{min} - occ_{r_{w}}, 0) + max(r_{max} - occ_{r_{w}}, 0) \big)  & \qquad &  \quad \label{obj:3}
%   \end{align}
% \end{subequations}
% \begin{align}
%     % \textrm{min} \quad & \sum_{k \in D} \sum_{l \in d^P_k} \sum_{i \in W} min(\sum_{j \in T} w_{ijkl}, 1) &+&  \sum_{j \in T}\sum_{k\in D}\sum_{l \in d^P_k} s_{jkl} \nonumber \\
%     % & + \sum_{r \in R} \big( max(r_{min} - occ_{r_{w}}, 0) &+&   max(r_{max} - occ_{r_{w}}, 0) \big)  \label{obj} \\
%     \textrm{s.t} \qquad & \sum_{i \in W} w_{ijkl} + s_{jkl} = 1, && \forall k \in D, j \in d_k^T, l \in d_k^P \label{wc1} \\
%     & \sum_{k \in D} \sum_{l \in d_k^P} w_{ijkl} \leq 1, && \forall i \in W, j \in T \label{wc2} \\
%     & t_j \notin d^T_{k} \implies \forall i, l \ w_{ijkl} = 0,  && \forall j \in T , k \in D \label{wc3} \\
%     & t_j \notin w^T_{i} \implies \forall k, l \ w_{ijkl} = 0, && \forall j \in T, i \in W \label{wc4} \\ 
%     & t_j \notin d^T_{k} \implies \forall l \ s_{jkl} = 0,  && \forall j \in T , k \in D \label{sc1} \\
%     & t_j \notin w^T_{i} \implies \forall l \ s_{jkl} = 0, && \forall j \in T, i \in W \label{sc2} \\ 
%     & \sum_{l \in d^P_k} w_{ajkl} + w_{bjkl} < 2, &&  \forall {(a, b) \in I_{ww}}, j \in T, k \in D \label{wc5} \\
%     & d^c_{k} = c \implies \forall l \ w_{ijkl} = 0, && \forall {(i, c) \in I_{wc}}, j \in T, k \in D \label{wc6} \\ 
%     & w_{ijkl} = 0, && \forall j \in T, k \in D, l \in d^P_k, \nonumber \\
%     & && i \in W \setminus W_{d^{s_l}_k} \label{wc7} \\
%     & \sum_{l \in d_k^P} w_{ijkl} \geq 1, && \forall j \in T, k \in D, s \in d^{S^+}_k, i \in W_{d^{S^+}_k} \label{wc8} \\
%     & z_i \notin d^Z_j \implies z_{ij} = 0, && \forall i \in Z, j \in D \label{zc1}  \\
%     & |d^Z_j| > 0 \implies \sum_{i \in Z} z_{ij} = 1, && \forall j \in D \label{zc2} \\
%     & z_{ij} + z_{ik} \leq 1, && \forall j \in D, k \in d^O_j, i \in Z \label{zc3} \\
%     & m_i \notin d^M_j \implies m_{ij} = 0, && \forall i \in M, j \in D  \label{mc1} \\
%     & \sum_{i \in M_k} m_{ij} = |d^{M_k}_j|, && j \in D, k \in d^M_j  \label{mc2} \\
%     & m_{ij} + m_{ik} \leq 1, && \forall j \in D, k \in d^O_j, i \in M  \label{mc3} \\
%     & w_{ijkl} \in \{0, 1\}, && \forall i \in W, j \in T, k \in D, l \in d^P_k \label{binary1} \\
%     & s_{jkl} \in \{0, 1\}, && \forall j \in T, k \in D, l \in d^P_k \label{binary2} \\
%     & m_{ij} \in \{0, 1\}, && \forall i \in M, j \in D \label{binary3} \\ 
%     & z_{ij} \in \{0, 1\}, && \forall i \in Z, j \in D \label{binary4} \\ 
%     & occ_i = \sum_{j \in T} \sum_{k \in D} \sum_{l \in d^P_j} w_{ijkl}, && \forall i \in W \label{occ}
% \end{align}
% \endgroup

    
% The objective function is stated in (\ref{obj}), it is split in multiple parts, it minimizes 
% \begin{enumerate*}[label=(\roman*)]
%   \item the number of different workers for every position between periods of that demand (\ref{obj:1}), $min(\sum_{j \in T} w_{ijkl}, 1)$ is one if the worker $i$ is working for that position at that time, 0 otherwise. Hence, the sum of that value for all worker will be equal to the number of worker for that shift;
%   \item the number of \emph{sentinel} worker assigned to demands (\ref{obj:2});
%   \item the number of violations of working requirements (\ref{obj:3}).
% \end{enumerate*}




% Constraint (\ref{wc1}) ensures that each position is filled by only one worker. The sentinel worker being a valid assignment is also part of the sum.

% Constraint (\ref{wc2}) ensures that no worker works for multiple demands at the same time period. 

% The constraints (\ref{wc3}) and (\ref{wc4}) ensures that no worker is working for a demand thais not occurring or when is himself not available. 

% The constraints (\ref{sc1}) and (\ref{sc2}) fullfil the same role as (\ref{wc3}) and (\ref{wc4}) but for sentinel variables. 



% Constraint (\ref{wc5}) ensures that no incompatible workers work together while (\ref{wc6}) ensures that no incompatible pair of worker and client work together. 

% Constraint (\ref{wc7}) ensures that no worker work for a position in which they are not qualified to work at. 
% Constraint (\ref{wc8}) ensures that for each additional skills, at least one worker in the group has that skill.

% Constraint (\ref{zc1}) ensures that no zone is assigned to a demand in which this zone is not a possible assignment. (\ref{zc2}) ensures that only one zone is assigned to this demand if this demand is in need of a zone. Constraint (\ref{zc3}) ensures that no zone is assigned to two overlapping demands in time.

% Constraint (\ref{mc1}) ensures that no machine is assigned to a demand not in need of that machine. Constraint (\ref{mc2}) ensures that the required number for each machine is satisfied. And again, (\ref{mc3}) ensures that no machine is assigned to two overlapping demands in time.


% Finally (\ref{binary1}), (\ref{binary2}), (\ref{binary3}) and (\ref{binary4}) ensure the variables only takes binary values.


\end{document}

