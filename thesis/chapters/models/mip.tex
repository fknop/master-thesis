% !TEX root = ../../thesis.tex

\documentclass[../../thesis.tex]{subfiles}
 
\begin{document}


\section{Mixed Integer Programming model}
\label{section:mipmodel}

We first start by presenting the mathematical model, we describe the variables
needed to model our problem and the constraints associated to them.

\subsection{Variables}

To represent our problem in MIP, we need three types of variables, one per resource.



\begin{equation*}
\begin{split}
    w_{ijkl} &=  \left \{
                   \begin{array}{l l}
                      1 \quad & \textrm{if worker $i$ is working at time $j$ for demand $k$ at position $l$} \\
                      0 \quad & \textrm{otherwise} 
                   \end{array}
                   \right . \\
  d_{jkl} &=  \left \{
  \begin{array}{l l}
      1 \quad & \textrm{if no worker is assigned at time $j$ for demand $k$ at position $l$ (dummy)} \\
      0 \quad & \textrm{otherwise} 
  \end{array}
  \right . \\
   m_{ij} &=  \left \{
                   \begin{array}{l l}
                      1 \quad & \textrm{if machine $i$ is used for demand $j$} \\
                      0 \quad & \textrm{otherwise} 
                   \end{array}
                   \right . \\
    l_{ij} &= \left \{
               \begin{array}{l l}
                  1 \quad & \textrm{if location $i$ is used for demand $j$} \\
                  0 \quad & \textrm{otherwise} 
               \end{array}
               \right . \\
\end{split}
\end{equation*}

This is, in fact, a binary Integer Programming model as every variable is a $\{0, 1\}$ integer.

As solutions can be partial, we need to introduce a way to allow the absence of worker for a 
given position. In MIP, we model this by having the variables $d_{jkl}$, $d$ for \emph{dummy}. This variable is one, if and only if all the 
corresponding worker variables ($w_{ijkl}, \forall_i$) are equal to zero. The goal is to minimize 
the number of dummy variables assigned to one.

\subsection{Constraints}

\subsubsection{All positions must be assigned with one worker}

  All positions must have one worker assigned to it. We achieve this by summing all the worker variables 
  for each position. We also add the dummy variable associated to this position to allow partial 
  solutions.

  \begin{align}
    \sum_{i \in W} w_{ijkl} + d_{jkl} = 1, && \forall k \in D, j \in T_{d_k}, l \in P_{d_k} & \label{wc1}
  \end{align}


\autoref{wc1:visu} shows a visualization of constraints (\ref{wc1}) and (\ref{wc2}) for one time period.
However, to simplify, we suppose that demands only need one worker, thus ignoring positions.

\begin{figure}[]
  \centering
  \begin{tikzpicture}[
    node distance=1mm and 0mm,
    baseline]
    \matrix (M1) [matrix of math nodes,row sep=0.2em, column sep=0.3em]
    {
      w_{11}  &  +  &  w_{21} &  +    & \dots   & +  &   w_{n1}  &= 1    \\
      +       &     &   +     &       &   &   & \\
      w_{12}  &  +  &  w_{22} &  +    & \dots   & +  &   w_{n2}  &= 1    \\
      +       &     &     +   &       &         &    &       +           \\   
      \vdots  &     &  \vdots &      & \ddots   &   &   \vdots    \\ 
      +       &     &     +   &       &         &    &       +           \\ 
      w_{1m}  &  +  &  w_{2m} &  +    & \dots   & +  &   w_{nm}  &= 1    \\ 
      \leq 1  &     &  \leq 1 &       &         &    &    \leq 1        \\
    };
    % \draw   (M1-1-7.north east) -- (M1-7-7.south east);
    % \draw   (M1-7-1.south west) -- (M1-7-7.south east);
    \draw[red,very thick] 
            (M1-1-1.north west) -| (M1-1-8.south east) -| (M1-1-1.north west);
    \draw[blue,very thick] 
      (M1-1-3.north west) -| (M1-8-3.south east) -| (M1-1-3.north west);
    \draw[purple,thick] 
      (M1-7-7.north west) -| (M1-7-7.south east) -| (M1-7-7.north west);
    \node (fv) [below right=of M1.south east,align=left,
                font=\sffamily\bfseries] {Different\\workers};
    \draw[blue!60,very thick,shorten >=1mm,-{Stealth[bend]}] 
            (fv.west) to [out=180,in=270] (M1-8-3.south);
    \node (fv2) [above right=of M1.north west,align=left,
     font=\sffamily\bfseries] {Position\\satisfied};
    \draw[red!60,very thick,shorten >=1mm,-{Stealth[bend]}] 
     (fv2.west) to [out=180,in=180] (M1-1-1.west);
     \node (fv3) [right=1cm of M1.east,align=left,
     font=\sffamily\bfseries] {Worker $n$ for\\demand $m$};
     \draw[purple!60,thick,shorten >=1mm,-{Stealth[bend]}] 
     (fv3.west) to [out=180,in=0] (M1-7-7.north east);
  \end{tikzpicture}

  \caption{Visualization of (\ref{wc1}) and (\ref{wc2}).}
  \label{wc1:visu}
\end{figure}

\subsubsection{All workers assigned in a time period must be different}

One worker can only work at one position per time period. For each worker, we add the sum of all its variables 
over each time period. This sum must be less than or equal to one to make sure a worker works at most once in the period.

\begin{align}
  \sum_{k \in D} \sum_{l \in P_{d_k}} w_{ijkl} \leq 1, && \forall i \in W, j \in T & \label{wc2} 
\end{align}


\subsubsection{Exclude impossible values}

Some resources (workers, locations, demands) cannot be assigned in some time periods. We need to set the variables to 0 if this is the case.

\begin{align}
  t_j \notin T_{d_k} \implies \forall i, l \ w_{ijkl} = 0,  && \forall j \in T , k \in D &\label{wc3} \\
  t_j \notin T_{w_i} \implies \forall k, l \ w_{ijkl} = 0, && \forall j \in T, i \in W &\label{wc4} \\
  t_j \notin T_{d_k} \implies \forall l \ d_{jkl} = 0,  && \forall j \in T , k \in D &\label{sc1} \\ 
  l_i \notin L_{d_j} \implies l_{ij} = 0, && \forall i \in L, j \in D& \label{lc1} \\ 
  m_i \notin M_{d_j} \implies m_{ij} = 0, && \forall i \in M, j \in D& \label{mc1} 
\end{align}


\subsubsection{Incompatibilities between workers and clients}

For each incompatibility $(i, c) \in I_{wc}$, we set every worker variables of worker $i$ if the client of the 
demand is $c$ to zero.

\begin{align}
  c_{d_k} = c \implies \forall l \ w_{ijkl} = 0, && \forall {(i, c) \in I_{wc}}, j \in T, k \in D &\label{wc6}
\end{align}

\subsubsection{Incompatibilities between workers}

For each incompatibility, for each demand, two workers cannot have both their variables assigned to one. 
We define that the sum over all the positions of the two incompatible workers must be lower than two.

\begin{align}
  \sum_{l \in P_{d_k}} w_{ajkl} + w_{bjkl} < 2, &&  \forall {(a, b) \in I_{w}}, j \in T, k \in D &\label{wc5}
\end{align}



\begin{figure}[]
  \centering
  \begin{tikzpicture}[
    node distance=1mm and 0mm,
    baseline]
    \matrix (M1) [matrix of math nodes,row sep=0.5em, column sep=0.3em]
    {
      \ & w_{11}  &  +  &  w_{21} &  +   &  w_{31} &  +   & \dots   & +  &   w_{n1}  \\
      \color{red} + & w_{12}  &  +  &  w_{22} &  +   & w_{32}  &  +   & \dots   & +  &   w_{n2}   \\
      \color{blue} + & w_{13}  &  +  &  w_{23} &  +   & w_{33}  &  +   & \dots   & +  &   w_{n3}   \\
      \ & \vdots  &     &  \vdots &      & \vdots  &      & \vdots   &   &   \vdots \\ 
      \ & w_{1m}  &  +  &  w_{2m} &  +   &  w_{3m} &  +   & \dots   & +  &   w_{nm}    \\
      \\
    };

    \draw[red] 
          (M1-2-2.south west) -| (M1-1-10.north east) -| (M1-2-2.south west);
    \draw[blue] 
      (M1-3-2.south west) -| (M1-2-10.north east) -| (M1-3-2.south west);
    
    \node[color=red] (fv) [right=of M1-1-10.south east,align=left,
    font=\sffamily\bfseries] {${< 2}$};

    \node[color=blue] (fv2) [right=of M1-3-10.north east,align=left,
     font=\sffamily\bfseries] {${< 2}$};

    \draw[purple,thick] 
        (M1-5-10.north west) -| (M1-5-10.south east) -| (M1-5-10.north west);
     \node (fv3) [right=1cm of M1.south east,align=left,
     font=\sffamily\bfseries] {Worker $m$ for\\position $n$};
     \draw[purple!60,thick,shorten >=1mm,-{Stealth[bend]}] 
     (fv3.west) to [out=180,in=0] (M1-5-10.east);
  \end{tikzpicture}

  \caption{Example of (\ref{wc5}) if $(w_1, w_2)$ and $(w_2, w_3)$ are incompatible pairs).}
  \label{wc5:visu}
\end{figure}

\subsubsection{Restrict skilled positions to skilled workers}

These constraints ensure that no worker is working for a position at which they are not qualified to work.
$W_{d^{s_l}_k}$ defines the set of workers that satisfy skill(s) $s_l$ of demand $k$. 

\begin{align}
  w_{ijkl} = 0, && \forall j \in T, k \in D, l \in P_{d_k}, i \in W \setminus W_{S_{d_k,l}}  \label{wc6}
\end{align}

\subsubsection{Additional skills must be satisfied}

An additional skill must be satisfied by at least one worker in a team. We sum 
over all the workers that satisfy the skill to check if at least one is working in the team.

\begin{align}
  \sum_{l \in P_{d_k}} w_{ijkl} \geq 1, && \forall j \in T, k \in D, s \in S^{+}_{d_k}, i \in W_{S^{+}_{d_k}}& \label{wc8}
\end{align}


\subsubsection{Location assignments should be satisfied}

For each demand that requires a location, we sum over all the location variables for this demand and check if only one is assigned.

\begin{align}
  |L_{d_j}| > 0 \implies \sum_{i \in L} l_{ij} = 1, && \forall j \in D& \label{lc2}
\end{align}

\subsubsection{No location should be assigned to overlapping demands}

For each demand and its overlapping demands, we check that a location is not assigned to both demands.
We do this with a sum lower than or equal to one.

\begin{align}
  l_{ij} + l_{ik} \leq 1, && \forall j \in D, k \in d^O_j, i \in L \label{lc3}
\end{align}


\subsubsection{Machine assignments should be satisfied}

For each demand, we check that each required machine is assigned to that demand.
In the set of machines $M$, we can have multiple machines equal to the same value $k$.
We define $M_k \subseteq M$ the set of all machines in $M$ equal to $k$.

\begin{align}
  \sum_{i \in M_k} m_{ij} = | \{ m \mid m \in M_{d_j}, m = k \} |, && j \in D, k \in M_{d_j} \label{mc2}
\end{align}


As an example, let us take a demand $d_0$ with $M_{d_0} = \{ 1, 1, 2, 3 \}$. This demand needs 
two machines of type $1$, one machine of type $2$ and one machine of type $3$.
Let us now imagine that we have in total three machines of type 1, two machines of type 2 and one machine of type 3.
We have six variables associated with this demand: $m_{00}, \dots, m_{50}$ with 
$m_{00}$ through $m_{20}$ the variables associated with the machines of type 1, $m_{30}$ and $m_{40}$ the variables 
associated with the machines of type 2 and $m_{50}$ the variable associated with the machine of type 3.
\autoref{mc2:visu} shows a visualization of this example.


\begin{figure}[]
  \centering
  \begin{tikzpicture}[
    node distance=1mm and 0mm,
    baseline]
    \matrix (M1) [matrix of math nodes,row sep=0.2em, column sep=0.3em]
    {
      m_{00}  &  +  &  m_{10} &  +  & m_{20}  & = & 2    \\
      m_{30}  &  +  &  m_{40} &  \   &    \     & = & 1    \\
      m_{50}  &  \  &    \     &  \   &    \    & = & 1    \\ 
    };
    % \draw  (M1-1-6.north west) -- (M1-3-6.south west);
    \draw[red,very thick] 
            (M1-1-1.north west) -| (M1-1-5.south east) -| (M1-1-1.north west);
    \draw[red,thick] 
    (M1-1-7.north west) -| (M1-1-7.south east) -| (M1-1-7.north west);
    \draw[blue,very thick] 
      (M1-2-1.north west) -| (M1-2-3.south east) -| (M1-2-1.north west);
    \draw[blue,thick] 
      (M1-2-7.north west) -| (M1-2-7.south east) -| (M1-2-7.north west);
    \draw[purple,thick] 
      (M1-3-1.north west) -| (M1-3-1.south east) -| (M1-3-1.north west);
    \draw[purple,thick] 
      (M1-3-7.north west) -| (M1-3-7.south east) -| (M1-3-7.north west);
    % \draw[blue!60,very thick,shorten >=1mm,-{Stealth[bend]}] 
    %         (fv.west) to [out=180,in=270] (M1-8-3.south);
    \node (fv) [left=of M1-1-1.west,align=left,
    font=\sffamily\bfseries] {Type 1};
    \node (fv2) [left=of M1-2-1.west,align=left,
    font=\sffamily\bfseries] {Type 2};
    \node (fv3) [left=of M1-3-1.west,align=left,
     font=\sffamily\bfseries] {Type 3};
    % \draw[red!60,very thick,shorten >=1mm,-{Stealth[bend]}] 
    %  (fv2.west) to [out=180,in=180] (M1-1-1.west);
    %  \node (fv3) [right=1cm of M1.east,align=left,
    %  font=\sffamily\bfseries] {Worker $n$ for\\demand $m$};
    %  \draw[purple!60,thick,shorten >=1mm,-{Stealth[bend]}] 
    %  (fv3.west) to [out=180,in=0] (M1-7-7.north east);
  \end{tikzpicture}

  \caption{Visualization example for (\ref{mc2}).}
  \label{mc2:visu}
\end{figure}


\subsubsection{No machine should be assigned to overlapping demands}

Following the same principle of (\ref{lc3}), we check that two machines are not assigned 
to two overlapping demands.

\begin{align}
  m_{ij} + m_{ik} \leq 1, && \forall j \in D, k \in d^O_j, i \in M  
\end{align}


\subsubsection{Binary constraints}

These constraints simply state that each variable must be a binary $\{ 0, 1 \}$ variable.

\begin{align}
  w_{ijkl} \in \{0, 1\}, && \forall i \in W, j \in T, k \in D, l \in P_{d_k} &\label{binary1} \\
  d_{jkl} \in \{0, 1\}, && \forall j \in T, k \in D, l \in P_{d_k}& \label{binary2} \\
  m_{ij} \in \{0, 1\}, && \forall i \in M, j \in D& \label{binary3} \\ 
  l_{ij} \in \{0, 1\}, && \forall i \in L, j \in D& \label{binary4} 
\end{align}




\subsection{Objective}


\begingroup
\allowdisplaybreaks
\begin{subequations}
  \label{obj}
  \begin{align}
    \textrm{min} \quad & \delta_0 \sum_{k \in D} \sum_{l \in  P_{d_k}} \sum_{i \in W} min(\sum_{j \in T} w_{ijkl}, 1) \label{obj:1} \\ 
      + \ & \delta_1 \sum_{r \in R} \big( max(r_{min} - occ_{r_{w}}, 0) + max(r_{max} - occ_{r_{w}}, 0) \big)  \label{obj:3} \\ 
      + \ &\delta_2 \sum_{j \in T}\sum_{k\in D}\sum_{l \in d^P_k} d_{jkl} \label{obj:2} \\ 
     \textrm{with} \quad & occ_i = \sum_{j \in T} \sum_{k \in D} \sum_{l \in  P_{d_k}} w_{ijkl}, \quad \forall i \in W  \nonumber \\ 
                         & \bm{\delta} = (\delta_0, \delta_1, \delta_2) \label{penalties:mip} \nonumber
  \end{align}
\end{subequations}
\endgroup


The objective function is stated in (\ref{obj}), it is a weighted sum split into multiple parts, it minimizes:

\begin{enumerate}
  \item The number of different workers for every position between periods of that demand (\ref{obj:1}), $min(\sum_{j \in T} w_{ijkl}, 1)$ is one if the worker $i$ is working for that position at that time, 0 otherwise. Hence, the sum of those values for all workers is equal to the number of workers for that shift.
  \item The number of violations of working requirements (\ref{obj:3}).
  \item The number of dummy workers assigned to demands (\ref{obj:2}).
\end{enumerate}

$occ_i$ represents the occurrences of worker $i$ while the penalties $\bm{\delta}$ are representative of the importance of each sub-objective.




\end{document}

